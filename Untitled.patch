<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">diff --git a/1.0.4.html b/1.0.4.html</p>
<p class="p1">index 7ce570e6393ff8d10a1a85615b33a1a82a7d59b8..ee0df8db4a0b125f5105dcf8ee954a9a2fd92212 100644</p>
<p class="p1">--- a/1.0.4.html</p>
<p class="p1">+++ b/1.0.4.html</p>
<p class="p1">@@ -398,50 +398,60 @@</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">     </span>const sendCommand = async (deviceType, command) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">       </span>let device, endpointOut;</p>
<p class="p1"><span class="Apple-converted-space">       </span>if (deviceType === 'tx') {</p>
<p class="p1"><span class="Apple-converted-space">         </span>device = txDevice;</p>
<p class="p1"><span class="Apple-converted-space">         </span>endpointOut = txEndpointOut;</p>
<p class="p1"><span class="Apple-converted-space">       </span>} else if (deviceType === 'rx') {</p>
<p class="p1"><span class="Apple-converted-space">         </span>device = rxDevice;</p>
<p class="p1"><span class="Apple-converted-space">         </span>endpointOut = rxEndpointOut;</p>
<p class="p1"><span class="Apple-converted-space">       </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">         </span>return;</p>
<p class="p1"><span class="Apple-converted-space">       </span>}</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">       </span>if (!device) {</p>
<p class="p1"><span class="Apple-converted-space">         </span>return;</p>
<p class="p1"><span class="Apple-converted-space">       </span>}</p>
<p class="p1"><span class="Apple-converted-space">       </span>try {</p>
<p class="p1"><span class="Apple-converted-space">         </span>await device.transferOut(endpointOut, textEncoder.encode(command + '\n'));</p>
<p class="p1"><span class="Apple-converted-space">       </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">         </span>console.error(`Send command to ${deviceType.toUpperCase()} error:`, error);</p>
<p class="p1"><span class="Apple-converted-space">         </span>log(`Error sending command to ${deviceType.toUpperCase()}: ${error.message}`);</p>
<p class="p1"><span class="Apple-converted-space">         </span>setConnectionStatus(deviceType, false);</p>
<p class="p1"><span class="Apple-converted-space">       </span>}</p>
<p class="p1"><span class="Apple-converted-space">     </span>};</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1">+<span class="Apple-converted-space">    </span>const sendTxCommand = async (command) =&gt; {</p>
<p class="p1">+<span class="Apple-converted-space">      </span>if (txDevice) {</p>
<p class="p1">+<span class="Apple-converted-space">        </span>return sendCommand('tx', command);</p>
<p class="p1">+<span class="Apple-converted-space">      </span>}</p>
<p class="p1">+<span class="Apple-converted-space">      </span>if (rxDevice) {</p>
<p class="p1">+<span class="Apple-converted-space">        </span>return sendCommand('rx', command);</p>
<p class="p1">+<span class="Apple-converted-space">      </span>}</p>
<p class="p1">+<span class="Apple-converted-space">      </span>log("No TX or RX device connected to send command.");</p>
<p class="p1">+<span class="Apple-converted-space">    </span>};</p>
<p class="p1">+</p>
<p class="p1"><span class="Apple-converted-space">     </span>const sendChannelToRX = async (channel) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">         </span>if (!rxDevice) {</p>
<p class="p1"><span class="Apple-converted-space">             </span>log("RX device not connected. Cannot send channel.");</p>
<p class="p1"><span class="Apple-converted-space">             </span>return;</p>
<p class="p1"><span class="Apple-converted-space">         </span>}</p>
<p class="p1"><span class="Apple-converted-space">         </span>try {</p>
<p class="p1"><span class="Apple-converted-space">             </span>const data = new Uint8Array([0x43, channel]); // 0x43 is ASCII for 'C'</p>
<p class="p1"><span class="Apple-converted-space">             </span>await rxDevice.transferOut(rxEndpointOut, data);</p>
<p class="p1"><span class="Apple-converted-space">             </span>log(`Sent RX ESB Channel: ${channel}`);</p>
<p class="p1"><span class="Apple-converted-space">         </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">             </span>console.error("Send channel to RX error:", error);</p>
<p class="p1"><span class="Apple-converted-space">             </span>log(`Error sending channel to RX: ${error.message}`);</p>
<p class="p1"><span class="Apple-converted-space">             </span>setConnectionStatus('rx', false);</p>
<p class="p1"><span class="Apple-converted-space">         </span>}</p>
<p class="p1"><span class="Apple-converted-space">     </span>};</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">     </span>const populateTxUI = (settings) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">       </span>currentTxSettingsCache = settings;</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">       </span>// Bank Selection</p>
<p class="p1"><span class="Apple-converted-space">       </span>bankSelectionGrid.innerHTML = '';</p>
<p class="p1"><span class="Apple-converted-space">       </span>for (let i = 0; i &lt; 12; i++) {</p>
<p class="p1"><span class="Apple-converted-space">         </span>const bankBtn = document.createElement('button');</p>
<p class="p1"><span class="Apple-converted-space">         </span>bankBtn.className = 'bank-btn p-3 text-sm font-semibold rounded-lg bg-slate-800 hover:bg-slate-700/70 transition-colors duration-150 transform hover:scale-105 active:scale-95 shadow-md';</p>
<p class="p1"><span class="Apple-converted-space">         </span>bankBtn.textContent = `${i + 1}`;</p>
<p class="p1">@@ -583,67 +593,69 @@</p>
<p class="p1"><span class="Apple-converted-space">         </span>keepReadingFlag = () =&gt; txKeepReading;</p>
<p class="p1"><span class="Apple-converted-space">       </span>} else if (deviceType === 'rx') {</p>
<p class="p1"><span class="Apple-converted-space">         </span>device = rxDevice;</p>
<p class="p1"><span class="Apple-converted-space">         </span>endpointIn = rxEndpointIn;</p>
<p class="p1"><span class="Apple-converted-space">         </span>keepReadingFlag = () =&gt; rxKeepReading;</p>
<p class="p1"><span class="Apple-converted-space">       </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">         </span>return;</p>
<p class="p1"><span class="Apple-converted-space">       </span>}</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">       </span>let incomingData = "";</p>
<p class="p1"><span class="Apple-converted-space">       </span>while (keepReadingFlag()) {</p>
<p class="p1"><span class="Apple-converted-space">         </span>try {</p>
<p class="p1"><span class="Apple-converted-space">           </span>let result = await device.transferIn(endpointIn, 512);</p>
<p class="p1"><span class="Apple-converted-space">           </span>if (result.status === 'ok' &amp;&amp; result.data.byteLength &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">             </span>incomingData += textDecoder.decode(result.data, { stream: true });</p>
<p class="p1"><span class="Apple-converted-space">             </span>let newlineIndex;</p>
<p class="p1"><span class="Apple-converted-space">             </span>while ((newlineIndex = incomingData.indexOf('\n')) !== -1) {</p>
<p class="p1"><span class="Apple-converted-space">               </span>const line = incomingData.slice(0, newlineIndex).trim();</p>
<p class="p1"><span class="Apple-converted-space">               </span>incomingData = incomingData.slice(newlineIndex + 1);</p>
<p class="p1"><span class="Apple-converted-space">               </span>if (line.startsWith('{')) {</p>
<p class="p1"><span class="Apple-converted-space">                 </span>try {</p>
<p class="p1"><span class="Apple-converted-space">                   </span>const parsedJson = JSON.parse(line);</p>
<p class="p1"><span class="Apple-converted-space">                   </span>if (deviceType === 'tx') {</p>
<p class="p1"><span class="Apple-converted-space">                     </span>populateTxUI(parsedJson);</p>
<p class="p1"><span class="Apple-converted-space">                   </span>} else if (deviceType === 'rx') {</p>
<p class="p1">-<span class="Apple-converted-space">                    </span>if (parsedJson.rssi !== undefined) {</p>
<p class="p1">+<span class="Apple-converted-space">                    </span>if (parsedJson.activeBank !== undefined) {</p>
<p class="p1">+<span class="Apple-converted-space">                      </span>populateTxUI(parsedJson);</p>
<p class="p1">+<span class="Apple-converted-space">                    </span>} else if (parsedJson.rssi !== undefined) {</p>
<p class="p1"><span class="Apple-converted-space">                       </span>updateRxRSSI(parsedJson.rssi);</p>
<p class="p1"><span class="Apple-converted-space">                     </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                       </span>populateRxUI(parsedJson);</p>
<p class="p1"><span class="Apple-converted-space">                     </span>}</p>
<p class="p1"><span class="Apple-converted-space">                   </span>}</p>
<p class="p1"><span class="Apple-converted-space">                 </span>} catch (e) {</p>
<p class="p1"><span class="Apple-converted-space">                   </span>log(`JSON Parse Error (${deviceType.toUpperCase()}): ${e.message}`);</p>
<p class="p1"><span class="Apple-converted-space">                 </span>}</p>
<p class="p1"><span class="Apple-converted-space">               </span>} else if (line.startsWith('cc:')) {</p>
<p class="p1"><span class="Apple-converted-space">                 </span>if (deviceType === 'tx') {</p>
<p class="p1"><span class="Apple-converted-space">                   </span>const parts = line.substring(3).split(',');</p>
<p class="p1"><span class="Apple-converted-space">                   </span>if (parts.length === 2) updateCCVisualizer(parseInt(parts[0]), parseInt(parts[1]));</p>
<p class="p1"><span class="Apple-converted-space">                 </span>}</p>
<p class="p1"><span class="Apple-converted-space">               </span>} else if (line.startsWith('bank_changed:')) {</p>
<p class="p1">-<span class="Apple-converted-space">                </span>if (deviceType === 'tx') {</p>
<p class="p1">-<span class="Apple-converted-space">                  </span>setTimeout(() =&gt; sendCommand('tx', 'get_settings'), 100);</p>
<p class="p1">+<span class="Apple-converted-space">                </span>if (deviceType === 'tx' || deviceType === 'rx') {</p>
<p class="p1">+<span class="Apple-converted-space">                  </span>setTimeout(() =&gt; sendTxCommand('get_settings'), 100);</p>
<p class="p1"><span class="Apple-converted-space">                 </span>}</p>
<p class="p1"><span class="Apple-converted-space">               </span>}</p>
<p class="p1"><span class="Apple-converted-space">             </span>}</p>
<p class="p1"><span class="Apple-converted-space">           </span>}</p>
<p class="p1"><span class="Apple-converted-space">         </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">           </span>if (error.message.includes("disconnected")) {</p>
<p class="p1"><span class="Apple-converted-space">             </span>log(`${deviceType.toUpperCase()} device disconnected.`);</p>
<p class="p1"><span class="Apple-converted-space">             </span>setConnectionStatus(deviceType, false);</p>
<p class="p1"><span class="Apple-converted-space">           </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">             </span>log(`Read loop error (${deviceType.toUpperCase()}): ${error.message}`);</p>
<p class="p1"><span class="Apple-converted-space">           </span>}</p>
<p class="p1"><span class="Apple-converted-space">           </span>if (deviceType === 'tx') txKeepReading = false;</p>
<p class="p1"><span class="Apple-converted-space">           </span>else if (deviceType === 'rx') rxKeepReading = false;</p>
<p class="p1"><span class="Apple-converted-space">           </span>break;</p>
<p class="p1"><span class="Apple-converted-space">         </span>}</p>
<p class="p1"><span class="Apple-converted-space">       </span>}</p>
<p class="p1"><span class="Apple-converted-space">     </span>}</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">     </span>// Modified connectDevice function to support both initial request and auto-reconnect</p>
<p class="p1"><span class="Apple-converted-space">     </span>const connectDevice = async (deviceType, vendorId, productId, deviceToConnect = null) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">       </span>let deviceObj, interfaceNum, endpointInNum, endpointOutNum;</p>
<p class="p1"><span class="Apple-converted-space">       </span>let connectionStatusEl = deviceType === 'tx' ? txConnectionStatusEl : rxConnectionStatusElCol;</p>
<p class="p1"><span class="Apple-converted-space">       </span>let deviceRef = deviceType === 'tx' ? txDevice : rxDevice;</p>
<p class="p1"><span class="Apple-converted-space">       </span>let keepReadingRef = deviceType === 'tx' ? txKeepReading : rxKeepReading;</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1">@@ -679,59 +691,60 @@</p>
<p class="p1"><span class="Apple-converted-space">             </span>if (alt.interfaceClass === 0xFF) { // Assuming a vendor-specific class</p>
<p class="p1"><span class="Apple-converted-space">               </span>interfaceNum = iface.interfaceNumber;</p>
<p class="p1"><span class="Apple-converted-space">               </span>for (const ep of alt.endpoints) {</p>
<p class="p1"><span class="Apple-converted-space">                 </span>if (ep.direction === 'out') endpointOutNum = ep.endpointNumber;</p>
<p class="p1"><span class="Apple-converted-space">                 </span>if (ep.direction === 'in') endpointInNum = ep.endpointNumber;</p>
<p class="p1"><span class="Apple-converted-space">               </span>}</p>
<p class="p1"><span class="Apple-converted-space">             </span>}</p>
<p class="p1"><span class="Apple-converted-space">           </span>}</p>
<p class="p1"><span class="Apple-converted-space">         </span>}</p>
<p class="p1"><span class="Apple-converted-space">         </span>if (interfaceNum === undefined) throw new Error("Interface not found for the selected device.");</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">         </span>await deviceObj.claimInterface(interfaceNum);</p>
<p class="p1"><span class="Apple-converted-space">         </span>await deviceObj.controlTransferOut({ requestType: 'class', recipient: 'interface', request: 0x22, value: 0x01, index: interfaceNum });</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">         </span>log(`${deviceType.toUpperCase()} device connected successfully!`);</p>
<p class="p1"><span class="Apple-converted-space">         </span>setConnectionStatus(deviceType, true);</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">         </span>if (deviceType === 'tx') {</p>
<p class="p1"><span class="Apple-converted-space">           </span>txDevice = deviceObj;</p>
<p class="p1"><span class="Apple-converted-space">           </span>txInterfaceNumber = interfaceNum;</p>
<p class="p1"><span class="Apple-converted-space">           </span>txEndpointIn = endpointInNum;</p>
<p class="p1"><span class="Apple-converted-space">           </span>txEndpointOut = endpointOutNum;</p>
<p class="p1"><span class="Apple-converted-space">           </span>txKeepReading = true;</p>
<p class="p1"><span class="Apple-converted-space">           </span>txWasConnected = true;</p>
<p class="p1"><span class="Apple-converted-space">           </span>readLoop('tx');</p>
<p class="p1">-<span class="Apple-converted-space">          </span>await sendCommand('tx', "get_settings");</p>
<p class="p1">+<span class="Apple-converted-space">          </span>await sendTxCommand("get_settings");</p>
<p class="p1"><span class="Apple-converted-space">         </span>} else if (deviceType === 'rx') {</p>
<p class="p1"><span class="Apple-converted-space">           </span>rxDevice = deviceObj;</p>
<p class="p1"><span class="Apple-converted-space">           </span>rxInterfaceNumber = interfaceNum;</p>
<p class="p1"><span class="Apple-converted-space">           </span>rxEndpointIn = endpointInNum;</p>
<p class="p1"><span class="Apple-converted-space">           </span>rxEndpointOut = endpointOutNum;</p>
<p class="p1"><span class="Apple-converted-space">           </span>rxKeepReading = true;</p>
<p class="p1"><span class="Apple-converted-space">           </span>rxWasConnected = true;</p>
<p class="p1"><span class="Apple-converted-space">           </span>readLoop('rx');</p>
<p class="p1">+<span class="Apple-converted-space">          </span>await sendTxCommand("get_settings");</p>
<p class="p1"><span class="Apple-converted-space">           </span>// Start polling for RSSI after successful connection</p>
<p class="p1"><span class="Apple-converted-space">           </span>if (rxRssiInterval) clearInterval(rxRssiInterval);</p>
<p class="p1"><span class="Apple-converted-space">           </span>rxRssiInterval = setInterval(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">               </span>if (rxDevice &amp;&amp; rxDevice.opened) {</p>
<p class="p1"><span class="Apple-converted-space">                   </span>sendCommand('rx', 'R'); // 'R' for Request RSSI</p>
<p class="p1"><span class="Apple-converted-space">               </span>}</p>
<p class="p1"><span class="Apple-converted-space">           </span>}, 50);</p>
<p class="p1"><span class="Apple-converted-space">         </span>}</p>
<p class="p1"><span class="Apple-converted-space">         </span>return true;</p>
<p class="p1"><span class="Apple-converted-space">       </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">         </span>if (error.message.includes("User cancelled") || error.message.includes("No device selected")) {</p>
<p class="p1"><span class="Apple-converted-space">           </span>log(`Connection for ${deviceType.toUpperCase()} cancelled by user.`);</p>
<p class="p1"><span class="Apple-converted-space">         </span>} else if (!(deviceRef &amp;&amp; error.message.includes("disconnected"))) {</p>
<p class="p1"><span class="Apple-converted-space">           </span>log(`Connection failed for ${deviceType.toUpperCase()}: ${error.message}`);</p>
<p class="p1"><span class="Apple-converted-space">         </span>}</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">         </span>if (deviceRef &amp;&amp; error.message.includes("disconnected")) {</p>
<p class="p1"><span class="Apple-converted-space">           </span>if (deviceType === 'tx') txDevice = null;</p>
<p class="p1"><span class="Apple-converted-space">           </span>else if (deviceType === 'rx') rxDevice = null;</p>
<p class="p1"><span class="Apple-converted-space">         </span>}</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">         </span>setConnectionStatus(deviceType, false);</p>
<p class="p1"><span class="Apple-converted-space">         </span>return false;</p>
<p class="p1"><span class="Apple-converted-space">       </span>} finally {</p>
<p class="p1"><span class="Apple-converted-space">         </span>updateButtonStates();</p>
<p class="p1">@@ -876,76 +889,76 @@</p>
<p class="p1"><span class="Apple-converted-space">     </span>connectRxButton.addEventListener('click', async () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">       </span>await connectDevice('rx', RX_VID, RX_PID); // Trigger requestDevice for initial connection</p>
<p class="p1"><span class="Apple-converted-space">       </span>startAutoReconnect(); // Restart auto-reconnect after manual connection</p>
<p class="p1"><span class="Apple-converted-space">     </span>});</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">     </span>disconnectTxButton.addEventListener('click', () =&gt; disconnectDevice('tx'));</p>
<p class="p1"><span class="Apple-converted-space">     </span>disconnectRxButton.addEventListener('click', () =&gt; disconnectDevice('rx')); // Use the correct button ID for RX</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">     </span>document.addEventListener('input', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">       </span>const target = e.target;</p>
<p class="p1"><span class="Apple-converted-space">       </span>if (target.id === 'brightness') brightnessValueEl.textContent = target.value;</p>
<p class="p1"><span class="Apple-converted-space">       </span>else if (target.id === 'midiChannel') midiChannelValueEl.textContent = target.value;</p>
<p class="p1"><span class="Apple-converted-space">       </span>else if (target.id === 'esbChannel') esbChannelValueEl.textContent = target.value;</p>
<p class="p1"><span class="Apple-converted-space">       </span>else if (target.id === 'rxEsbChannel-col') rxEsbChannelValueElCol.textContent = target.value;</p>
<p class="p1"><span class="Apple-converted-space">     </span>});</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">     </span>// The 'change' event listener is now responsible for sending commands</p>
<p class="p1"><span class="Apple-converted-space">     </span>// when a control's value is finalized (e.g., mouse release for sliders)</p>
<p class="p1"><span class="Apple-converted-space">     </span>document.addEventListener('change', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">       </span>const t = e.target;</p>
<p class="p1"><span class="Apple-converted-space">       </span>const action = t.dataset.action;</p>
<p class="p1"><span class="Apple-converted-space">       </span>const deviceType = t.closest('#main-controls-tx') ? 'tx' : 'rx';</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">       </span>if (deviceType === 'tx') {</p>
<p class="p1"><span class="Apple-converted-space">         </span>let cmd = `set_${action}=${t.dataset.index ? t.dataset.index + ',' : ''}${t.value}`;</p>
<p class="p1">-<span class="Apple-converted-space">        </span>sendCommand('tx', cmd);</p>
<p class="p1">-<span class="Apple-converted-space">        </span>if (action === 'cc' || action === 'label') setTimeout(() =&gt; sendCommand('tx', 'get_settings'), 200);</p>
<p class="p1">+<span class="Apple-converted-space">        </span>sendTxCommand(cmd);</p>
<p class="p1">+<span class="Apple-converted-space">        </span>if (action === 'cc' || action === 'label') setTimeout(() =&gt; sendTxCommand('get_settings'), 200);</p>
<p class="p1"><span class="Apple-converted-space">       </span>} else if (deviceType === 'rx' &amp;&amp; action === 'rx_esb_ch') {</p>
<p class="p1"><span class="Apple-converted-space">         </span>// Snap RX ESB Channel value to the nearest 5</p>
<p class="p1"><span class="Apple-converted-space">         </span>const rawValue = parseInt(t.value);</p>
<p class="p1"><span class="Apple-converted-space">         </span>const snappedValue = Math.round(rawValue / 5) * 5;</p>
<p class="p1"><span class="Apple-converted-space">         </span>t.value = snappedValue; // Update slider position</p>
<p class="p1"><span class="Apple-converted-space">         </span>rxEsbChannelValueElCol.textContent = snappedValue; // Update display</p>
<p class="p2"><span class="Apple-converted-space">         </span></p>
<p class="p1"><span class="Apple-converted-space">         </span>// Send the single command to set the channel on release</p>
<p class="p1"><span class="Apple-converted-space">         </span>sendChannelToRX(snappedValue);</p>
<p class="p1"><span class="Apple-converted-space">       </span>}</p>
<p class="p1"><span class="Apple-converted-space">     </span>});</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">     </span>document.addEventListener('click', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">       </span>const target = e.target.closest('button');</p>
<p class="p1"><span class="Apple-converted-space">       </span>if (!target) return;</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">       </span>if (target.classList.contains('bank-btn')) {</p>
<p class="p1"><span class="Apple-converted-space">         </span>document.querySelectorAll('.bank-btn').forEach(btn =&gt; btn.classList.remove('active'));</p>
<p class="p1"><span class="Apple-converted-space">         </span>target.classList.add('active');</p>
<p class="p1">-<span class="Apple-converted-space">        </span>sendCommand('tx', `set_bank=${target.dataset.bank}`);</p>
<p class="p1">+<span class="Apple-converted-space">        </span>sendTxCommand(`set_bank=${target.dataset.bank}`);</p>
<p class="p1"><span class="Apple-converted-space">       </span>} else if (target.id === 'bleToggleButton') {</p>
<p class="p1">-<span class="Apple-converted-space">        </span>sendCommand('tx', 'toggle_ble');</p>
<p class="p1">+<span class="Apple-converted-space">        </span>sendTxCommand('toggle_ble');</p>
<p class="p1"><span class="Apple-converted-space">       </span>} else if (target.id === 'startCalButton') {</p>
<p class="p1">-<span class="Apple-converted-space">        </span>sendCommand('tx', 'start_cal');</p>
<p class="p1">+<span class="Apple-converted-space">        </span>sendTxCommand('start_cal');</p>
<p class="p1"><span class="Apple-converted-space">         </span>log("Calibration started. Follow device instructions.");</p>
<p class="p1"><span class="Apple-converted-space">       </span>}</p>
<p class="p1"><span class="Apple-converted-space">     </span>});</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">     </span>// Initial setup on window load</p>
<p class="p1"><span class="Apple-converted-space">     </span>window.onload = () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">       </span>updateButtonStates(); // Set initial button states</p>
<p class="p1"><span class="Apple-converted-space">       </span>updateUIVisibility(); // Set initial UI visibility</p>
<p class="p1"><span class="Apple-converted-space">       </span>startAutoReconnect(); // Start the alternating auto-reconnect loop</p>
<p class="p1"><span class="Apple-converted-space">     </span>};</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">     </span>// USB device connect/disconnect event listeners for the browser</p>
<p class="p1"><span class="Apple-converted-space">     </span>navigator.usb.addEventListener('connect', (event) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">       </span>const device = event.device;</p>
<p class="p1"><span class="Apple-converted-space">       </span>log(`USB Device connected: ${device.productName} (VID: 0x${device.vendorId.toString(16)}, PID: 0x${device.productId.toString(16)})`);</p>
<p class="p1"><span class="Apple-converted-space">       </span>// Attempt to connect newly connected device if it matches our VIDs/PIDs</p>
<p class="p1"><span class="Apple-converted-space">       </span>if (device.vendorId === TX_VID &amp;&amp; device.productId === TX_PID) {</p>
<p class="p1"><span class="Apple-converted-space">         </span>connectDevice('tx', TX_VID, TX_PID, device);</p>
<p class="p1"><span class="Apple-converted-space">       </span>} else if (device.vendorId === RX_VID &amp;&amp; device.productId === RX_PID) {</p>
<p class="p1"><span class="Apple-converted-space">         </span>connectDevice('rx', RX_VID, RX_PID, device);</p>
<p class="p1"><span class="Apple-converted-space">       </span>}</p>
<p class="p1"><span class="Apple-converted-space">       </span>startAutoReconnect(); // Restart auto-reconnect on any USB connect event</p>
<p class="p1"><span class="Apple-converted-space">     </span>});</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">     </span>navigator.usb.addEventListener('disconnect', (event) =&gt; {</p>
<p class="p1">@@ -956,26 +969,25 @@</p>
<p class="p1"><span class="Apple-converted-space">         </span>txKeepReading = false;</p>
<p class="p1"><span class="Apple-converted-space">         </span>txWasConnected = false;</p>
<p class="p1"><span class="Apple-converted-space">         </span>setConnectionStatus('tx', false);</p>
<p class="p1"><span class="Apple-converted-space">       </span>} else if (device.vendorId === RX_VID &amp;&amp; device.productId === RX_PID) {</p>
<p class="p1"><span class="Apple-converted-space">         </span>if(rxRssiInterval) {</p>
<p class="p1"><span class="Apple-converted-space">             </span>clearInterval(rxRssiInterval);</p>
<p class="p1"><span class="Apple-converted-space">             </span>rxRssiInterval = null;</p>
<p class="p1"><span class="Apple-converted-space">         </span>}</p>
<p class="p1"><span class="Apple-converted-space">         </span>rxDevice = null;</p>
<p class="p1"><span class="Apple-converted-space">         </span>rxKeepReading = false;</p>
<p class="p1"><span class="Apple-converted-space">         </span>rxWasConnected = false;</p>
<p class="p1"><span class="Apple-converted-space">         </span>setConnectionStatus('rx', false);</p>
<p class="p1"><span class="Apple-converted-space">         </span>rxEsbChannelSliderCol.value = 0;</p>
<p class="p1"><span class="Apple-converted-space">         </span>rxEsbChannelValueElCol.textContent = '';</p>
<p class="p1"><span class="Apple-converted-space">         </span>rxRssiValueElCol.textContent = '-- dBm';</p>
<p class="p1"><span class="Apple-converted-space">         </span>verticalRssiBar.style.height = '0%';</p>
<p class="p1"><span class="Apple-converted-space">       </span>}</p>
<p class="p1"><span class="Apple-converted-space">       </span>updateButtonStates();</p>
<p class="p1"><span class="Apple-converted-space">       </span>updateUIVisibility();</p>
<p class="p1"><span class="Apple-converted-space">       </span>startAutoReconnect(); // Always restart auto-reconnect</p>
<p class="p1"><span class="Apple-converted-space">     </span>});</p>
<p class="p2"><span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">   </span>&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space"> </span>&lt;/body&gt;</p>
<p class="p1"><span class="Apple-converted-space"> </span>&lt;/html&gt;</p>
<p class="p1">-</p>
</body>
</html>
